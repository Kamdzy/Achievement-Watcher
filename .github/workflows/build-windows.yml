name: Build Windows Installer and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Cache OBS Studio
      - name: Cache OBS Studio
        id: cache-obs
        uses: actions/cache@v4
        with:
          path: service/obs
          key: obs-studio-31.0.3-${{ runner.os }}

      # 3. Download OBS if not cached
      - name: Download OBS if not cached
        if: steps.cache-obs.outcome != 'cache-hit'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path service/obs
          Invoke-WebRequest -Uri https://github.com/obsproject/obs-studio/releases/download/31.0.3/OBS-Studio-31.0.3-Windows.zip -OutFile obs.zip
          Expand-Archive -Path obs.zip -DestinationPath service/obs -Force
          Remove-Item obs.zip

      # 4. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 14

      # 5. Setup MSBuild (for native modules)
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1

      # 6. Setup Visual Studio environment
      - name: Setup VS Build Environment
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`vswhere.exe -latest -products * -requires Microsoft.Component.MSBuild -property installationPath`) do (
            call "%%i\VC\Auxiliary\Build\vcvars64.bat"
          )

      # 7. Install node-gyp
      - name: Install node-gyp
        run: |
          npm install --global node-gyp@9.4.1
          npm config set node_gyp "$(npm prefix -g)\node_modules\node-gyp\bin\node-gyp.js"
          npm config set msvs_version 2022

      # 8. Install dependencies
      - name: Install dependencies
        working-directory: app
        env:
          PUPPETEER_SKIP_DOWNLOAD: false
        run: |
          npm ci --no-optional
          npx patch-package

      # 9. Verify puppeteer
      - name: Verify Puppeteer Installation
        working-directory: app
        run: node -e "console.log('Puppeteer path:', require.resolve('puppeteer')); const puppeteer = require('puppeteer'); console.log('Puppeteer loaded successfully');"

      # 9b. Install watchdog service dependencies
      - name: Install watchdog service dependencies
        working-directory: service/watchdog
        shell: cmd
        run: |
          REM Set VS path for node-gyp
          for /f "usebackq delims=" %%i in (`vswhere.exe -latest -property installationPath`) do set "VS_PATH=%%i"
          
          echo VS Installation Path: %VS_PATH%
          
          REM Initialize VS environment for Windows SDK
          call "%VS_PATH%\VC\Auxiliary\Build\vcvars64.bat"
          if errorlevel 1 (
            echo ERROR: Failed to initialize VS environment
            exit /b 1
          )
          
          REM Set npm config for VS
          npm config set msvs_version 2022
          npm config set msbuild_path "%VS_PATH%\MSBuild\Current\Bin\MSBuild.exe"
          
          echo Installing watchdog service dependencies...
          REM Install dependencies
          npm ci --production
          if errorlevel 1 (
            echo ERROR: Failed to install watchdog dependencies
            exit /b 1
          )
          
          echo Watchdog service dependencies installed successfully!

      # 10. Rebuild native modules
      - name: Rebuild Native Modules
        working-directory: app
        shell: cmd
        run: |
          REM Set VS path for node-gyp
          for /f "usebackq delims=" %%i in (`vswhere.exe -latest -property installationPath`) do set "VS_PATH=%%i"
          
          echo VS Installation Path: %VS_PATH%
          
          REM Initialize VS environment
          call "%VS_PATH%\VC\Auxiliary\Build\vcvars64.bat"
          if errorlevel 1 (
            echo ERROR: Failed to initialize VS environment
            exit /b 1
          )
          
          REM Set npm config for VS
          npm config set msvs_version 2022
          npm config set msbuild_path "%VS_PATH%\MSBuild\Current\Bin\MSBuild.exe"
          
          echo Starting electron-rebuild...
          REM Rebuild with explicit VS path
          npx electron-rebuild --force --debug --ms-build-path="%VS_PATH%\MSBuild\Current\Bin\MSBuild.exe"
          if errorlevel 1 (
            echo ERROR: electron-rebuild failed
            exit /b 1
          )
          
          echo Native module rebuild completed successfully!

      # 11. Cache Electron headers
      - name: Cache Electron headers
        uses: actions/cache@v4
        with:
          path: ~/.electron
          key: electron-headers-${{ runner.os }}-12.2.3

      # 12. Build Windows installer
      - name: Build installer
        working-directory: app
        env:
          DEBUG: electron-builder
          DEBUG_COLORS: 1
        run: npx electron-builder --windows --publish never

      - name: Get version from package.json
        id: get_version
        shell: pwsh
        run: |
          $pkg = Get-Content -Raw app\package.json | ConvertFrom-Json
          Write-Output "version=$($pkg.version)" >> $env:GITHUB_ENV

      # 13. Create GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.version }}
          release_name: Release ${{ env.version }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.REGISTRY_TOKEN }}

      # 14. Upload installer to release
      - name: Upload installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app/dist/Achievement.Watcher.Setup.${{ env.version }}.exe
          asset_name: Achievement.Watcher.Setup.${{ env.version }}.exe
          asset_content_type: application/octet-stream

      # 15. Upload latest.yml
      - name: Upload latest.yml
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app/dist/latest.yml
          asset_name: latest.yml
          asset_content_type: application/octet-stream

      # 16. Upload blockmap
      - name: Upload blockmap
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app/dist/Achievement.Watcher.Setup.${{ env.version }}.exe.blockmap
          asset_name: Achievement.Watcher.Setup.${{ env.version }}.exe.blockmap
          asset_content_type: application/octet-stream
